<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="launch-remote" default="update-benchmarks-servers" basedir=".">
	<property environment="env"/>
	<property name="diffusion.dir" value="${env.DIFFUSION_HOME}" />
    <property name="test.server3" value="test3" />
    <property name="test.server2" value="192.168.54.22" />
    <property name="test.server3" value="217.37.86.227" />
    <property name="test.server2" value="217.37.86.226" />
    <import file="build.xml"/>
	<!-- TODO: 
		Set up server configuration before running the tests
		Deploy new version of diffusion remotely
		Deploy new version of load-runner remotely
		Fail build if results do not match expectations
	-->
	<target name="run-benchmarks-on-two-servers" depends="clean,dist">
		<update-benchmark-server server="${test.server2}" />
		<update-benchmark-server server="${test.server3}" />

		<sshexec host="${test.server2}" username="root" password="ds10hd" command="cd benchmark-server;nohup numactl -N 1 -m 1 ant -f throughput-suite.xml -Ddiffusion.protocol=ws -Ddiffusion.host=test3 -Dtest.name.contains=1000b-ramping-messages-10C-100T &amp;" />
		<wait-for-remote-process-to-die server="${test.server2}" />
	</target>
	<target name="wait-for-test3" depends="">
		<wait-for-remote-process-to-die server="${test.server3}" />
	</target>
	<target name="update-benchmarks-servers" depends="clean,dist">
        <update-benchmark-server server="${test.server3}" />
    </target>
	<target name="run-benchmarks-on-server" depends="clean,dist">
		<update-benchmark-server server="${test.server3}" />
	    <sshexec host="${test.server3}" username="root" password="ds10hd" 
			command="cd benchmark-server;nohup numactl -N 1 -m 1 ant -f throughput-suite.xml -Ddiffusion.protocol=ws &amp;" />
		<wait-for-remote-process-to-die server="${test.server3}"/>
	</target>
	<macrodef name="update-benchmark-server">
		<attribute name="server" />
		<sequential>
			<property name="temp" value="@{server}" />
			<scp trust="true" todir="root:ds10hd@${temp}:/root" file="benchmark-server.zip" />
			<var name="temp" unset="true" />
			<sshexec host="@{server}" username="root" password="ds10hd" command="rm -rf benchmark-server" trust="true"/>
			<sshexec host="@{server}" username="root" password="ds10hd" command="unzip benchmark-server.zip -d benchmark-server" trust="true"/>
			<sshexec host="@{server}" username="root" password="ds10hd" command="rm -f benchmark-server.zip" trust="true"/>
		</sequential>
	</macrodef>
	<target name="run-benchmarks-on-server-no-update" depends="">
		<sshexec host="${test.server3}" username="root" password="ds10hd" command="cd benchmark-server;nohup numactl -N 1 -m 1 ant -f throughput-suite.xml -Ddiffusion.protocol=dpt -Dtest.name.contains=125b" />
		<wait-for-remote-process-to-die server="${test.server3}" />
		<sshexec host="${test.server3}" username="root" password="ds10hd" command="cd benchmark-server;nohup numactl -N 1 -m 1 ant -f throughput-suite.xml -Ddiffusion.protocol=http -Dtest.name.contains=125b" />
		<wait-for-remote-process-to-die server="${test.server3}" />
		<sshexec host="${test.server3}" username="root" password="ds10hd" command="cd benchmark-server;nohup numactl -N 1 -m 1 ant  -f throughput-suite.xml -Ddiffusion.protocol=ws -Dtest.name.contains=125b" />
		<wait-for-remote-process-to-die server="${test.server3}" />
	</target>

	<macrodef name="wait-for-remote-process-to-die">
		<attribute name="process.command.contains" default="ant-launcher" />
		<attribute name="ps" default="ps ax |grep @{process.command.contains} |grep -v grep " />
		<attribute name="server" />
		<sequential>
			<sshexec host="@{server}" username="root" password="ds10hd" command="@{ps}" outputproperty="ps.out" failonerror="false" />
			<if>
				<equals arg1="${ps.out}" arg2="" />
				<then>
					<var name="ps.out" unset="true" />
				</then>
				<else>
					<var name="ps.out" unset="true" />
					<sleep minutes="1" />
					<wait-for-remote-process-to-die server="@{server}" />
				</else>
			</if>
		</sequential>
	</macrodef>

	<target name="update-server-diffusion-jars">
        <scp todir="root:ds10hd@${test.server3}:/root/Diffusion4.5.0_dev/lib/" file="${diffusion.dir}/lib/diffusion.jar" trust="true"/>
        <scp todir="root:ds10hd@${test.server3}:/root/Diffusion4.5.0_dev/lib/" file="${diffusion.dir}/lib/diffusionclient.jar" trust="true"/>
        <scp todir="root:ds10hd@${test.server3}:/root/Diffusion4.5.0_dev/lib/" file="${diffusion.dir}/lib/tools.jar" trust="true"/>
	</target>
</project>
